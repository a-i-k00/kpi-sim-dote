<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ドテラ目標達成シミュレーション</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=M+PLUS+Rounded+1c:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Annotation Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    /* リセット＆ベーススタイル */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html {
      font-size: 16px;
    }
    body {
      font-family: 'M PLUS Rounded 1c', 'Noto Sans JP', 'Roboto', sans-serif;
      /* Y2K風の明るいグラデーション背景に変更 */
      background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
      color: #333333;
      padding: 20px;
      line-height: 1.6;
      min-height: 100vh;
    }
    h1, h2, h3 {
      margin-bottom: 10px;
      font-weight: 700;
      font-family: 'M PLUS Rounded 1c', 'Roboto', sans-serif;
    }
    h1 {
      text-align: center;
      /* ネオンカラータッチのタイトル */
      color: #6a11cb;
      margin-bottom: 20px;
      position: relative;
      padding-bottom: 10px;
      /* 大胆なフォントスタイル */
      font-size: 2.5rem;
      letter-spacing: -0.5px;
    }
    h1:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      /* ネオンカラーのグラデーション */
      background: linear-gradient(90deg, #fc6076, #ff9a44);
      border-radius: 3px;
    }
    p {
      margin-bottom: 15px;
    }
    .explanation {
      font-size: 0.85em;
      color: #444444;
      text-align: center;
      max-width: 800px;
      margin: 0 auto 20px;
      line-height: 1.5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      /* グラスモーフィズム効果 */
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 30px;
      /* Y2K風の薄いボーダー */
      border: 1px solid rgba(255, 255, 255, 0.5);
      transition: all 0.3s ease;
    }

    /* 入力フォームセクション */
    .input-section {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      /* グラスモーフィズム効果 */
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      /* Y2K風の薄いボーダー */
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .input-group {
      display: flex;
      flex-direction: column;
      flex: 1 1 200px;
      position: relative;
    }
    label {
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 0.85rem;
      /* ネオンカラータッチのラベル */
      color: #6a11cb;
      letter-spacing: 0.5px;
    }
    input,
    select {
      padding: 12px;
      /* グラスモーフィズム効果のインプット */
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    input:focus,
    select:focus {
      border-color: #fc6076;
      outline: none;
      box-shadow: 0 0 0 3px rgba(252, 96, 118, 0.2);
    }
    button {
      cursor: pointer;
      padding: 12px 24px;
      /* Y2K風ネオングラデーション */
      background: linear-gradient(45deg, #fc6076 0%, #ff9a44 100%);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(252, 96, 118, 0.3);
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(252, 96, 118, 0.4);
    }
    button:active {
      transform: translateY(-1px);
    }
    
    /* カジュアルなホバーエフェクト追加 */
    .button-hover {
      position: relative;
      overflow: hidden;
    }
    .button-hover:after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }
    .button-hover:hover:after {
      transform: translateX(0);
    }

    /* 目安表 */
    .reference-table {
      font-size: 0.7em;
      color: #444444;
      margin-bottom: 0;
    }
    .reference-table table {
      width: 100%;
      border-collapse: collapse;
    }
    .reference-table th,
    .reference-table td {
      /* Y2K風の明るいボーダー */
      border: 1px solid rgba(252, 96, 118, 0.2);
      padding: 4px;
      text-align: center;
    }
    .reference-table th {
      /* Y2K風の明るい背景 */
      background: rgba(252, 96, 118, 0.1);
    }

    /* 出力ブロック：目安表と出力結果 */
    .output-container {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
    .reference-container {
      flex: 1;
      /* グラスモーフィズム効果 */
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      padding: 15px;
      border-radius: 12px;
      /* Y2K風の薄いボーダー */
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    /* kpiUnified: single container for KPI & Rank achievement */
    .kpiUnified {
      flex: 1;
      padding: 20px;
      /* グラスモーフィズム効果 */
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      /* Y2K風の薄いボーダー */
      border: 1px solid rgba(255, 255, 255, 0.5);
      display: flex;
      flex-direction: column;
      gap: 25px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    /* タイトル追加 */
    .kpiUnified-title {
      text-align: center;
      font-size: 1.2rem;
      font-weight: 700;
      /* ネオンカラー */
      color: #6a11cb;
      margin-bottom: 5px;
      letter-spacing: 0.5px;
    }

    .kpiUnified-row {
      display: flex;
      gap: 30px;
      align-items: stretch;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    .kpiUnified-col {
      flex: 1;
      min-width: 150px;
      max-width: 200px;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      /* グラスモーフィズム効果 */
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border-radius: 12px;
      padding: 15px 10px;
      /* Y2K風の薄いボーダー */
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .kpiUnified-col:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }
    /* 項目名は小さく */
    .kpiUnified-col h3 {
      margin-bottom: 10px;
      font-size: 0.85rem;
      font-weight: 700;
      /* ネオンカラー */
      color: #6a11cb;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    /* 数値とラベルを縦に配置 */
    .kpiUnified-col p {
      margin: 0;
      line-height: 1.2;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .kpiUnified-col p strong {
      font-size: 2.8em;
      font-weight: 900;
      /* ネオンカラーのグラデーションテキスト */
      background: linear-gradient(45deg, #fc6076 0%, #ff9a44 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      transition: all 0.5s ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    /* 単位ラベルのスタイル */
    .kpiUnified-col p span {
      font-size: 0.9em;
      margin-top: 5px;
      color: #666;
    }
    /* 達成月の(～か月後)は小さく、太字ではない */
    .achieve-later {
      font-size: 0.7em !important;
      font-weight: normal;
      color: #333;
      margin-top: 5px;
      display: block;
    }
    
    /* ツールチップスタイル - 長いテキスト用 */
    .text-tooltip {
      position: relative;
      cursor: help;
    }
    .text-tooltip:hover::after {
      content: attr(data-full-text);
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      /* ネオンカラーの背景 */
      background: linear-gradient(45deg, rgba(106, 17, 203, 0.9), rgba(37, 117, 252, 0.9));
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      z-index: 100;
      font-size: 0.8rem;
      white-space: nowrap;
      margin-top: 5px;
      /* Y2K風の薄いボーダー */
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      font-weight: normal;
    }

    /* シミュレーションテーブル */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      /* グラスモーフィズム効果 */
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border-radius: 12px;
      overflow: hidden;
      /* Y2K風の薄いボーダー */
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }
    thead {
      /* Y2K風の明るい背景 */
      background: linear-gradient(45deg, rgba(252, 96, 118, 0.1), rgba(255, 154, 68, 0.1));
    }
    th,
    td {
      /* Y2K風の明るいボーダー */
      border: 1px solid rgba(252, 96, 118, 0.1);
      padding: 10px;
      text-align: right;
      font-size: 0.9rem;
      transition: background 0.2s ease;
    }
    th {
      font-weight: 700;
      text-align: center;
      /* ネオンカラー */
      color: #6a11cb;
    }
    tbody tr.year-break {
      border-top: 3px solid #fc6076;
    }
    tbody tr:nth-child(even) {
      background: rgba(252, 96, 118, 0.05);
    }
    tbody tr:hover {
      background: rgba(252, 96, 118, 0.1);
    }

    /* チャート表示エリア */
    .charts-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      justify-content: space-between;
      margin-bottom: 30px;
    }
    .chart-container {
      flex: 1;
      min-width: 300px;
      max-width: 600px;
      /* グラスモーフィズム効果 */
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      padding: 20px;
      /* Y2K風の薄いボーダー */
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }
    .chart-container:hover {
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
      transform: translateY(-5px);
    }
    .chart-container h2 {
      /* ネオンカラー */
      color: #6a11cb;
      text-align: center;
      margin-bottom: 15px;
      font-size: 1.2rem;
      /* Y2K風のテキスト効果 */
      letter-spacing: 1px;
    }
    canvas {
      width: 100% !important;
      height: auto !important;
    }

    /* レスポンシブ対応 */
    @media (max-width: 1024px) {
      .charts-wrapper {
        flex-direction: column;
      }
      .chart-container {
        max-width: 100%;
      }
    }
    
    @media (max-width: 768px) {
      .input-section,
      .output-container {
        flex-direction: column;
      }
      
      .reference-container, 
      .kpi-accordion-container {
        width: 100%;
        margin-bottom: 20px;
      }
      
      .accordion-container {
        grid-template-columns: 1fr 1fr;
      }
      
      /* テーブルの横スクロール対応 */
      #kpiTable {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        max-width: 100%;
        -webkit-overflow-scrolling: touch;
      }
    }
    
    @media (max-width: 480px) {
      .accordion-container {
        grid-template-columns: 1fr;
      }
      
      .accordion-card {
        min-width: 100%;
      }
      
      .number-selector {
        width: calc(100% - 25px); /* ツールチップアイコン分の余白 */
      }
      
      .container {
        padding: 15px;
      }
      
      h1 {
        font-size: 1.8rem;
      }
    }

    /* エクスポートボタン */
    .export-container {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
      gap: 10px;
    }
    .export-btn {
      display: inline-flex;
      align-items: center;
      padding: 10px 18px;
      /* Y2K風ネオングラデーション */
      background: linear-gradient(45deg, #fc6076 0%, #ff9a44 100%);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(252, 96, 118, 0.3);
    }
    .export-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(252, 96, 118, 0.4);
    }
    .export-btn:active {
      transform: translateY(-1px);
    }
    .export-btn svg {
      margin-right: 8px;
      width: 16px;
      height: 16px;
    }

    /* シナリオ保存機能 */
    .scenario-container {
      margin-top: 20px;
      padding: 20px;
      /* グラスモーフィズム効果 */
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border-radius: 12px;
      /* Y2K風の薄いボーダー */
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }
    .scenario-title {
      font-weight: 700;
      margin-bottom: 10px;
      /* ネオンカラー */
      color: #6a11cb;
      font-size: 1.2rem;
      /* Y2K風のテキスト効果 */
      letter-spacing: 1px;
    }
    .scenario-description {
      font-size: 0.85em;
      color: #444444;
      text-align: center;
      max-width: 800px;
      margin: 0 auto 20px;
      line-height: 1.5;
    }
    .scenario-form {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      margin-bottom: 15px;
    }
    .scenario-list {
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
      /* グラスモーフィズム効果 */
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border-radius: 8px;
      /* Y2K風の薄いボーダー */
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .scenario-item {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .scenario-item:last-child {
      border-bottom: none;
    }
    .scenario-item:hover {
      background: rgba(252, 96, 118, 0.1);
    }
    .scenario-actions {
      display: flex;
      gap: 8px;
    }
    .scenario-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      /* Y2K風グラデーション (薄め) */
      background: linear-gradient(45deg, rgba(252, 96, 118, 0.7) 0%, rgba(255, 154, 68, 0.7) 100%);
      color: white;
      transition: all 0.2s ease;
    }
    .scenario-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(252, 96, 118, 0.3);
    }
    .scenario-btn.delete {
      background: linear-gradient(45deg, rgba(255, 76, 76, 0.7), rgba(255, 123, 123, 0.7));
    }
    .scenario-btn.delete:hover {
      background: linear-gradient(45deg, rgba(255, 76, 76, 0.9), rgba(255, 123, 123, 0.9));
    }

    /* スライダー用スタイル */
    .slider-container {
      margin-top: 5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .slider {
      flex: 1;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      /* Y2K風のグラデーションスライダートラック */
      background: linear-gradient(90deg, rgba(252, 96, 118, 0.3), rgba(255, 154, 68, 0.3));
      outline: none;
      border-radius: 5px;
      transition: all 0.3s;
    }
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      /* Y2K風のネオングラデーションのスライダーつまみ */
      background: linear-gradient(135deg, #fc6076, #ff9a44);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(252, 96, 118, 0.4);
      transition: all 0.3s;
    }
    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.3);
      box-shadow: 0 4px 12px rgba(252, 96, 118, 0.6);
    }
    .slider-value {
      min-width: 60px;
      font-size: 0.85rem;
      padding: 4px 8px;
      border-radius: 6px;
      /* グラスモーフィズム効果 */
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      /* Y2K風の薄いボーダー */
      border: 1px solid rgba(255, 255, 255, 0.3);
      text-align: center;
    }

    /* 数値セレクター用スタイル */
    .number-selector {
      display: flex;
      align-items: center;
      /* グラスモーフィズム効果 */
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      /* Y2K風の薄いボーダー */
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      overflow: hidden;
      width: 100%;
      position: relative;
    }
    .number-selector input {
      border: none;
      box-shadow: none;
      text-align: center;
      flex: 1;
      padding: 10px 0;
      width: 60px;
      background: transparent;
    }
    .number-selector input:focus {
      box-shadow: none;
    }
    .number-btn {
      /* Y2K風ネオングラデーション */
      background: linear-gradient(45deg, #fc6076 0%, #ff9a44 100%);
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      color: white;
      font-weight: bold;
      transition: all 0.3s;
    }
    .number-btn:hover {
      background: linear-gradient(45deg, #ff7a98 0%, #ffb76f 100%);
    }
    /* ツールチップアイコンの位置調整 */
    .input-group .tooltip-icon {
      right: -25px;
      top: 10px;
    }
    .input-group .number-selector + .tooltip-icon {
      right: -25px;
      top: 10px;
    }

    /* アコーディオンレイアウトの改善 */
    .kpi-accordion-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .accordion-section-title {
      font-size: 1.2rem;
      font-weight: 700;
      /* ネオンカラー */
      color: #6a11cb;
      margin-bottom: 15px;
      text-align: center;
      /* Y2K風のテキスト効果 */
      letter-spacing: 1px;
    }
    .accordion-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 15px;
      margin-bottom: 10px;
    }
    .accordion-row {
      display: contents;
    }
    .accordion-card {
      position: relative;
      padding: 15px;
      /* グラスモーフィズム効果 */
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border-radius: 12px;
      /* Y2K風の薄いボーダー */
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      overflow: hidden;
      cursor: pointer;
      flex: 1;
      min-width: 140px;
    }
    .accordion-card:hover {
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
      transform: translateY(-5px);
    }
    .accordion-card::after {
      content: "＋";
      position: absolute;
      top: 10px;
      right: 12px;
      /* ネオンカラー */
      color: #6a11cb;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      /* Y2K風の明るい背景 */
      background: rgba(252, 96, 118, 0.1);
      border-radius: 50%;
    }
    .accordion-card.expanded::after {
      content: "−";
      background: rgba(252, 96, 118, 0.2);
    }
    .accordion-title {
      font-size: 0.9rem;
      font-weight: 700;
      /* ネオンカラー */
      color: #6a11cb;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
      padding-right: 25px;
    }
    .accordion-value {
      font-size: 2.2em;
      font-weight: 900;
      /* ネオンカラーのグラデーションテキスト */
      background: linear-gradient(45deg, #fc6076 0%, #ff9a44 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      padding-right: 20px;
      display: flex;
      align-items: baseline;
    }
    .accordion-value .unit {
      font-size: 0.5em;
      margin-left: 5px;
      color: #666;
      font-weight: 500;
      /* グラデーションテキストを上書き */
      background: none;
      -webkit-background-clip: initial;
      -webkit-text-fill-color: #666;
    }
    .accordion-details {
      height: 0;
      overflow: hidden;
      transition: height 0.3s ease;
      margin-top: 5px;
    }
    .accordion-card.expanded .accordion-details {
      height: auto;
      padding-top: 10px;
      border-top: 1px solid rgba(252, 96, 118, 0.2);
    }
    .accordion-details-content {
      font-size: 0.85rem;
      line-height: 1.4;
      color: #555;
    }
    
    /* テーブル注釈 */
    .table-note {
      margin-bottom: 15px;
      padding: 12px;
      /* グラスモーフィズム効果 */
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border-radius: 8px;
      /* Y2K風の薄いボーダー */
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .table-note p {
      margin: 0;
      font-size: 0.85rem;
      color: #555;
    }
    
    /* Y2K風のパーティクル効果 - 画面装飾用 */
    .particle-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
      overflow: hidden;
    }
    .particle {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: linear-gradient(45deg, rgba(252, 96, 118, 0.6), rgba(255, 154, 68, 0.6));
      animation: float 15s infinite linear;
    }
    @keyframes float {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: 0.8;
      }
      90% {
        opacity: 0.8;
      }
      100% {
        transform: translateY(-100vh) rotate(360deg);
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <div class="particle-container"></div>
  <div class="container">
    <h1>ドテラ目標達成シミュレーション</h1>
    <p class="explanation">
      下記フォームで【現在のPV】、【今年の目標Rank】、【目標PV】に加え、「新規登録者目標数(月平均)」
      （＝毎月の新規登録者数期待値）と【目標設定日】を入力すると、ファネル型のシミュレーション（各月24カ月分）・グラフ、
      さらにシミュレーションのPV予測（OV）が目標PVに初めて到達する月を自動判定して表示します。
    </p>

    <!-- 入力フォーム -->
    <div class="input-section">
      <div class="input-group">
        <label for="currentPV">現在の PV</label>
        <input type="number" id="currentPV" value="3000" min="0" />
        <div class="slider-container">
          <input type="range" id="currentPVSlider" min="0" max="50000" step="500" value="3000" class="slider">
          <div class="slider-value">3000</div>
        </div>
      </div>
      <div class="input-group">
        <label for="yearGoal">今年の目標 Rank</label>
        <select id="yearGoal">
          <option value="EXECUTIVE">EXECUTIVE</option>
          <option value="ELITE">ELITE</option>
          <option value="PREMIERE">PREMIERE</option>
          <option value="SILVER" selected>SILVER</option>
          <option value="GOLD">GOLD</option>
          <option value="PLATINUM">PLATINUM</option>
          <option value="DIAMOND">DIAMOND</option>
          <option value="BLUE DIAMOND">BLUE DIAMOND</option>
          <option value="PRESIDENTIAL">PRESIDENTIAL</option>
        </select>
      </div>
      <div class="input-group">
        <label for="goalPV">目標 PV</label>
        <input type="number" id="goalPV" value="9000" min="0" />
        <div class="slider-container">
          <input type="range" id="goalPVSlider" min="0" max="200000" step="1000" value="9000" class="slider">
          <div class="slider-value">9000</div>
        </div>
      </div>
      <div class="input-group">
        <label for="monthlyTarget">新規登録者目標数(月平均)</label>
        <div class="number-selector">
          <button class="number-btn decrease button-hover">−</button>
          <input type="number" id="monthlyTarget" value="7" step="1" min="0" max="1000" />
          <button class="number-btn increase button-hover">＋</button>
        </div>
      </div>
      <div class="input-group">
        <label for="targetDate">目標設定日</label>
        <input type="date" id="targetDate" value="2025-01-01" />
      </div>
    </div>

    <!-- 出力ブロック： 目安表 + KPI&目標Rank達成 -->
    <div class="output-container">
      <div class="reference-container">
        <strong>ランク別目標値 目安表</strong>
        <table class="reference-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>PV</th>
              <th>登録者</th>
              <th>目安月収$</th>
              <th>目安月収¥</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>EXECUTIVE</td>
              <td>2,000</td>
              <td>13</td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>ELITE</td>
              <td>3,000</td>
              <td>20</td>
              <td>$300</td>
              <td>¥39,000</td>
            </tr>
            <tr>
              <td>PREMIERE</td>
              <td>5,000</td>
              <td>27</td>
              <td>$600</td>
              <td>¥78,000</td>
            </tr>
            <tr>
              <td>SILVER</td>
              <td>9,000</td>
              <td>60</td>
              <td>$2,125</td>
              <td>¥276,250</td>
            </tr>
            <tr>
              <td>GOLD</td>
              <td>12,000</td>
              <td>80</td>
              <td>$4,667</td>
              <td>¥606,710</td>
            </tr>
            <tr>
              <td>PLATINUM</td>
              <td>27,000</td>
              <td>180</td>
              <td>$8,750</td>
              <td>¥1,137,500</td>
            </tr>
            <tr>
              <td>DIAMOND</td>
              <td>36,000</td>
              <td>240</td>
              <td>$10,683</td>
              <td>¥1,388,790</td>
            </tr>
            <tr>
              <td>BLUE DIAMOND</td>
              <td>60,000</td>
              <td>400</td>
              <td>$36,500</td>
              <td>¥4,745,000</td>
            </tr>
            <tr>
              <td>PRESIDENTIAL</td>
              <td>162,000</td>
              <td>1,080</td>
              <td>$106,833</td>
              <td>¥13,888,290</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- 新しいアコーディオン式ダッシュボード -->
      <div class="kpi-accordion-container">
        <h3 class="accordion-section-title">あなたの目標達成に向けた数値</h3>
        <div class="accordion-container" id="kpiAccordionContainer">
          <!-- JavaScriptで動的に生成 -->
        </div>
      </div>
    </div>

    <!-- チャート表示エリア -->
    <div class="charts-wrapper">
      <div class="chart-container">
        <h2>1年予測</h2>
        <canvas id="chartYear1"></canvas>
      </div>
      <div class="chart-container">
        <h2>2年予測</h2>
        <canvas id="chartYear2"></canvas>
      </div>
    </div>

    <!-- KPI シミュレーション テーブル（24カ月分） -->
    <h2>KPI シミュレーション (月次)</h2>
    <div class="table-note">
      <p><strong>LRP継続率：80%</strong> - 新規登録者の80%がLRPを継続すると想定しています。このシミュレーションでは毎月の新規登録者の80%がLRPに継続する前提で計算しています。</p>
    </div>
    <table id="kpiTable">
      <thead>
        <tr>
          <th>月</th>
          <th>サンプル配布数</th>
          <th>講座参加数</th>
          <th>新規登録者数</th>
          <th>LRP継続者数</th>
          <th>User数</th>
          <th>シェアラー</th>
          <th>ビルダー育成数</th>
          <th>OV (PV予測)</th>
        </tr>
      </thead>
      <tbody>
        <!-- シミュレーションデータは JavaScript で生成 -->
      </tbody>
    </table>

    <!-- エクスポートボタン -->
    <div class="export-container">
      <button id="exportBtn" class="export-btn button-hover">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        CSVでエクスポート
      </button>
    </div>

    <!-- シナリオ保存機能 -->
    <div class="scenario-container">
      <div class="scenario-title">シナリオ保存</div>
      <p class="scenario-description">
        現在の設定を名前を付けて保存します。保存したシナリオはブラウザのローカルストレージに記録され、
        このデバイスとブラウザでのみ利用できます。
      </p>
      <div class="scenario-form">
        <input type="text" id="scenarioName" placeholder="シナリオ名を入力">
        <button id="saveScenarioBtn" class="button-hover">シナリオ保存</button>
      </div>
      <div class="scenario-list">
        <!-- シナリオリストは JavaScript で生成 -->
      </div>
    </div>
  </div>

  <script>
    /************************************************
     * シミュレーションロジック:
     * LRP継続者数は毎月累積
     * User = 累積 LRP
     * シェアラー = 50% of User (その月時点), 累積しない
     * ビルダー育成数 = 20% of シェアラー(その月), 累積しない
     * OV = currentPV + (月数 × newReg × 150)
     *   初月 m=0 => currentPV + (newReg * 150)
     *   2ヶ月目 => currentPV + (2* newReg * 150)
     *   ...
     ************************************************/

    function recalcKpiData() {
      const newRegInput = parseFloat(document.getElementById("monthlyTarget").value)||7;
      const newReg = Math.floor(newRegInput);

      let currentPV = parseFloat(document.getElementById("currentPV").value);
      if(isNaN(currentPV)) currentPV=3000;

      const targetDateStr = document.getElementById("targetDate").value;
      let startDate = targetDateStr ? new Date(targetDateStr): new Date();

      // サンプル配布数 = floor(newReg*(30/11))
      // 講座参加数     = floor(newReg*(21/11))
      // 新規登録者数   = newReg
      // LRP継続率80% => LRP= floor(newReg*0.8) (月ごと追加)

      const sampleEach = Math.floor(newReg*(30/11));
      const lectureEach= Math.floor(newReg*(21/11));
      const lrpEach   = Math.floor(newReg*0.8);

      // OV multiplier
      const ovMultiplier=150;

      let simData=[];

      // 累積LRP
      let cumLRP=0;
      let prevYear;

      for(let m=0; m<24; m++) {
        let simDate = new Date(
          startDate.getFullYear(),
          startDate.getMonth()+m,
          startDate.getDate()
        );
        let newYearBreak=false;
        if(m===0) {
          prevYear=simDate.getFullYear();
        } else {
          if(simDate.getFullYear()!==prevYear){
            newYearBreak=true;
            prevYear=simDate.getFullYear();
          }
        }

        // LRP累積
        if(m>0) {
          cumLRP += lrpEach;
        } else {
          // 初月
          cumLRP= lrpEach;
        }

        // user= cumLRP
        // sharer= floor(user*0.5)
        // builder= floor(sharer*0.2)
        const user = cumLRP;
        const sharer= Math.floor(user*0.5);
        const builder= Math.floor(sharer*0.2);

        // OV
        // m=0 => currentPV + newReg*150
        // m>0 => currentPV + ( (m+1)* newReg *150 )
        let OV;
        if(m===0) {
          OV= currentPV + newReg*ovMultiplier;
        } else {
          OV= currentPV + ( (m+1)* newReg* ovMultiplier );
        }
        let OVFormatted= OV.toLocaleString();

        let monthLabel= simDate.getFullYear()+"年"+(simDate.getMonth()+1)+"月";

        simData.push({
          monthLabel,
          sample: sampleEach,
          lecture: lectureEach,
          newReg,
          lrp: cumLRP,
          user: cumLRP,
          sharer,
          builder,
          OV: OVFormatted,
          newYearBreak
        });
      }
      return simData;
    }

    // KPI出力
    function updateKpiResults(){
      const simData = recalcKpiData();

      const newRegInput = parseFloat(document.getElementById("monthlyTarget").value)||7;
      const newReg = Math.floor(newRegInput);

      // 12か月後のビルダー育成数 => simData[11].builder
      //  (ただし、配列が0-basedなので12か月目は index=11 )
      let builderAt12 = 0;
      if(simData.length >= 12){
        builderAt12 = simData[11].builder;
      }

      // 年換算 新規登録者
      const annualNew = newReg*12;

      // 目標達成
      const goalPV = parseFloat(document.getElementById("goalPV").value)||9000;
      let achieveMonthLine1 = "未達";
      let achieveMonthLine2 = "";

      for(let i=0; i<simData.length; i++) {
        const ovNum = parseInt(simData[i].OV.replace(/,/g,""));
        if(ovNum>=goalPV){
          achieveMonthLine1 = simData[i].monthLabel;
          achieveMonthLine2 = `(${i+1}カ月後)`;
          break;
        }
      }

      // 目標Rank
      const goalRank = document.getElementById("yearGoal").value;
      
      // アコーディオンコンテナを取得
      const accordionContainer = document.getElementById("kpiAccordionContainer");
      
      // アコーディオンカードを生成
      accordionContainer.innerHTML = `
        <!-- 上段：新規登録者とビルダー育成数 -->
        <div class="accordion-row">
          <!-- 新規登録者カード -->
          <div class="accordion-card" id="newRegCard">
            <div class="accordion-title">新規登録者</div>
            <div class="accordion-value">${annualNew}<span class="unit">名/年</span></div>
            <div class="accordion-details">
              <div class="accordion-details-content">
                月間平均${newReg}名の新規登録者を想定。<br>
                年間${annualNew}名の新規登録を見込んでいます。
              </div>
            </div>
          </div>
          
          <!-- ビルダー育成数カード -->
          <div class="accordion-card" id="builderCard">
            <div class="accordion-title">ビルダー育成数</div>
            <div class="accordion-value">${builderAt12}<span class="unit">名/年</span></div>
            <div class="accordion-details">
              <div class="accordion-details-content">
                12ヶ月後の時点で${builderAt12}名のビルダーが育成される見込みです。<br>
                ビルダー育成数はシェアラーの20%と想定しています。
              </div>
            </div>
          </div>
        </div>
        
        <!-- 下段：目標Rankと達成月 -->
        <div class="accordion-row">
          <!-- 目標Rankカード -->
          <div class="accordion-card" id="goalRankCard">
            <div class="accordion-title">目標Rank</div>
            <div class="accordion-value">${goalRank}</div>
            <div class="accordion-details">
              <div class="accordion-details-content">
                ${goalRank}ランクの達成条件：<br>
                ${getRankDetails(goalRank)}
              </div>
            </div>
          </div>
          
          <!-- 達成月カード -->
          <div class="accordion-card" id="achieveMonthCard">
            <div class="accordion-title">達成月</div>
            <div class="accordion-value">${achieveMonthLine1 === "未達" ? "未達" : achieveMonthLine1}</div>
            <div class="accordion-details">
              <div class="accordion-details-content">
                ${
                  achieveMonthLine1 === "未達" ? 
                  "シミュレーション期間(24ヶ月)内では目標達成できません。<br>さらに長期のシミュレーションが必要です。" : 
                  `目標達成まで${achieveMonthLine2.replace(/[()]/g, '')}かかる見込みです。<br>現在のPVから毎月のシミュレーション結果に基づいて算出されています。`
                }
              </div>
            </div>
          </div>
        </div>
      `;
      
      // アコーディオンの動作設定
      setupAccordion();
    }
    
    // Rank詳細情報を取得する関数
    function getRankDetails(rank) {
      const rankDetails = {
        "EXECUTIVE": "• 必要PV: 2,000<br>• 目安登録者数: 13名",
        "ELITE": "• 必要PV: 3,000<br>• 目安登録者数: 20名<br>• 目安月収: $300 (¥39,000)",
        "PREMIERE": "• 必要PV: 5,000<br>• 目安登録者数: 27名<br>• 目安月収: $600 (¥78,000)",
        "SILVER": "• 必要PV: 9,000<br>• 目安登録者数: 60名<br>• 目安月収: $2,125 (¥276,250)",
        "GOLD": "• 必要PV: 12,000<br>• 目安登録者数: 80名<br>• 目安月収: $4,667 (¥606,710)",
        "PLATINUM": "• 必要PV: 27,000<br>• 目安登録者数: 180名<br>• 目安月収: $8,750 (¥1,137,500)",
        "DIAMOND": "• 必要PV: 36,000<br>• 目安登録者数: 240名<br>• 目安月収: $10,683 (¥1,388,790)",
        "BLUE DIAMOND": "• 必要PV: 60,000<br>• 目安登録者数: 400名<br>• 目安月収: $36,500 (¥4,745,000)",
        "PRESIDENTIAL": "• 必要PV: 162,000<br>• 目安登録者数: 1,080名<br>• 目安月収: $106,833 (¥13,888,290)"
      };
      
      return rankDetails[rank] || "詳細情報がありません";
    }
    
    // アコーディオンの動作を設定する関数
    function setupAccordion() {
      const accordionCards = document.querySelectorAll('.accordion-card');
      accordionCards.forEach(card => {
        // 既存のイベントリスナーを削除（重複を防ぐため）
        card.removeEventListener('click', handleAccordionClick);
        // 新しいイベントリスナーを追加
        card.addEventListener('click', handleAccordionClick);
      });
    }
    
    // クリックイベントハンドラー
    function handleAccordionClick() {
      this.classList.toggle('expanded');
      const details = this.querySelector('.accordion-details');
      
      if (this.classList.contains('expanded')) {
        details.style.height = details.scrollHeight + 'px';
      } else {
        details.style.height = '0';
      }
    }

    function onUpdate(){
      // 更新時のアニメーション効果
      const accordionContainer = document.getElementById("kpiAccordionContainer");
      accordionContainer.style.opacity = "0.5";
      accordionContainer.style.transform = "translateY(10px)";
      
      setTimeout(() => {
        updateKpiResults();
        const simData = recalcKpiData();
        populateKpiTable(simData);
        renderCharts(simData);
        
        // アニメーション終了
        accordionContainer.style.opacity = "1";
        accordionContainer.style.transform = "translateY(0)";
      }, 300);
    }

    // シミュレーションテーブル
    function populateKpiTable(simData){
      const tbody= document.getElementById("kpiTable").querySelector("tbody");
      tbody.innerHTML= "";
      simData.forEach(row=>{
        const tr= document.createElement("tr");
        if(row.newYearBreak){
          tr.classList.add("year-break");
        }
        let cells = [
          row.monthLabel,
          row.sample,
          row.lecture,
          row.newReg,
          row.lrp,
          row.user,
          row.sharer,
          row.builder,
          row.OV
        ];
        cells.forEach(cell=>{
          const td= document.createElement("td");
          td.textContent= cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    // グラフ
    let chart1, chart2;
    function renderCharts(simData){
      Chart.register(window["chartjs-plugin-annotation"]);
      if(chart1) chart1.destroy();
      if(chart2) chart2.destroy();

      const goalPV= parseFloat(document.getElementById("goalPV").value)||9000;

      // 1年
      const dataYear1= simData.slice(0,12);
      const labelsYear1= dataYear1.map((row,i)=>{
        if(i===0||row.newYearBreak){
          return row.monthLabel;
        } else {
          return row.monthLabel.split("年")[1];
        }
      });
      const newRegYear1= dataYear1.map(r=> parseInt(r.newReg||0));
      const lrpYear1= dataYear1.map(r=> parseInt(r.lrp||0));
      const OVYear1= dataYear1.map(r=> parseInt(r.OV.replace(/,/g,"")));

      let achieveIndexYear1= -1;
      for(let i=0; i<OVYear1.length; i++){
        if(OVYear1[i]>= goalPV){
          achieveIndexYear1= i;
          break;
        }
      }

      const achieveBorderColor= "rgba(252, 96, 118, 0.8)";
      const achieveBgColor= "rgba(252, 96, 118, 0.2)";

      const ctx1= document.getElementById("chartYear1").getContext("2d");
      chart1= new Chart(ctx1, {
        type: "bar",
        data: {
          labels: labelsYear1,
          datasets: [
            {
              label:"新規登録者数",
              data:newRegYear1,
              backgroundColor:"rgba(252, 96, 118, 0.7)",
              stack:"stack1"
            },
            {
              label:"LRP継続者数",
              data:lrpYear1,
              backgroundColor:"rgba(255, 154, 68, 0.7)",
              stack:"stack1"
            },
            {
              label:"OV (PV予測)",
              data:OVYear1,
              type:"line",
              yAxisID:"yOv",
              borderColor:"rgba(106, 17, 203, 0.8)",
              backgroundColor:"rgba(106, 17, 203, 0.2)",
              fill:true,
              tension:0.3
            }
          ]
        },
        options:{
          responsive:true,
          interaction:{mode:"index", intersect:false},
          plugins:{
            annotation:{
              annotations:(()=>{
                if(achieveIndexYear1===-1)return {};
                return {
                  line1:{
                    type:"line",
                    xMin: achieveIndexYear1,
                    xMax: achieveIndexYear1,
                    borderColor: achieveBorderColor,
                    borderWidth:2,
                    label:{
                      enabled:true,
                      position:"top",
                      content:"達成",
                      backgroundColor: achieveBgColor,
                      color: achieveBorderColor
                    }
                  }
                };
              })()
            }
          },
          scales:{
            x:{stacked:true},
            y:{
              stacked:true,
              title:{display:true,text:"数値"}
            },
            yOv:{
              position:"right",
              title:{display:true,text:"PV (OV)"},
              grid:{drawOnChartArea:false}
            }
          }
        }
      });

      // 2年
      const dataYear2= simData.slice(12,24);
      const labelsYear2= dataYear2.map((row,i)=>{
        if(i===0||row.newYearBreak){
          return row.monthLabel;
        } else {
          return row.monthLabel.split("年")[1];
        }
      });
      const newRegYear2= dataYear2.map(r=> parseInt(r.newReg||0));
      const lrpYear2= dataYear2.map(r=> parseInt(r.lrp||0));
      const OVYear2= dataYear2.map(r=> parseInt(r.OV.replace(/,/g,"")));

      let achieveIndexYear2= -1;
      if(achieveIndexYear1===-1){
        for(let i=0; i<OVYear2.length; i++){
          if(OVYear2[i]>=goalPV){
            achieveIndexYear2= i;
            break;
          }
        }
      }

      const ctx2= document.getElementById("chartYear2").getContext("2d");
      chart2= new Chart(ctx2, {
        type:"bar",
        data:{
          labels: labelsYear2,
          datasets:[
            {
              label:"新規登録者数",
              data:newRegYear2,
              backgroundColor:"rgba(252, 96, 118, 0.7)",
              stack:"stack2"
            },
            {
              label:"LRP継続者数",
              data:lrpYear2,
              backgroundColor:"rgba(255, 154, 68, 0.7)",
              stack:"stack2"
            },
            {
              label:"OV (PV予測)",
              data:OVYear2,
              type:"line",
              yAxisID:"yOv2",
              borderColor:"rgba(106, 17, 203, 0.8)",
              backgroundColor:"rgba(106, 17, 203, 0.2)",
              fill:true,
              tension:0.3
            }
          ]
        },
        options:{
          responsive:true,
          interaction:{mode:"index", intersect:false},
          plugins:{
            annotation:{
              annotations:(()=>{
                if(achieveIndexYear2===-1)return {};
                return {
                  line2:{
                    type:"line",
                    xMin: achieveIndexYear2,
                    xMax: achieveIndexYear2,
                    borderColor: achieveBorderColor,
                    borderWidth:2,
                    label:{
                      enabled:true,
                      position:"top",
                      content:"達成",
                      backgroundColor: achieveBgColor,
                      color: achieveBorderColor
                    }
                  }
                };
              })()
            }
          },
          scales:{
            x:{stacked:true},
            y:{
              stacked:true,
              title:{display:true,text:"数値"}
            },
            yOv2:{
              position:"right",
              title:{display:true,text:"PV (OV)"},
              grid:{drawOnChartArea:false}
            }
          }
        }
      });
    }

    // シミュレーションデータをCSVにエクスポート
    function exportToCSV(simData) {
      // ヘッダー行
      const headers = [
        "月", "サンプル配布数", "講座参加数", "新規登録者数", 
        "LRP継続者数", "User数", "シェアラー", "ビルダー育成数", "OV (PV予測)"
      ];
      
      // BOM（Byte Order Mark）を追加して日本語の文字化けを防止
      let csvContent = "\uFEFF";
      
      // ヘッダー行を追加
      csvContent += headers.join(",") + "\n";
      
      // データ行を追加
      simData.forEach(row => {
        const csvRow = [
          row.monthLabel,
          row.sample,
          row.lecture,
          row.newReg,
          row.lrp,
          row.user,
          row.sharer,
          row.builder,
          row.OV.replace(/,/g, "") // カンマを削除
        ];
        csvContent += csvRow.join(",") + "\n";
      });
      
      try {
        // Blobオブジェクトを作成
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        
        // ダウンロードリンクを作成
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        
        link.setAttribute("href", url);
        link.setAttribute("download", "シミュレーション結果_" + new Date().toISOString().split('T')[0] + ".csv");
        link.style.visibility = "hidden";
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        console.log("CSVエクスポートが完了しました");
      } catch (error) {
        console.error("CSVエクスポートエラー:", error);
        alert("エクスポート中にエラーが発生しました。");
      }
    }

    // シナリオ管理機能
    function saveCurrentScenario(name) {
      // 現在の入力値を取得
      const scenarioData = {
        name: name || `シナリオ ${new Date().toLocaleString()}`,
        currentPV: parseFloat(document.getElementById("currentPV").value) || 3000,
        yearGoal: document.getElementById("yearGoal").value,
        goalPV: parseFloat(document.getElementById("goalPV").value) || 9000,
        monthlyTarget: parseFloat(document.getElementById("monthlyTarget").value) || 7,
        targetDate: document.getElementById("targetDate").value,
        timestamp: new Date().getTime()
      };
      
      // ローカルストレージから既存のシナリオを取得
      let savedScenarios = JSON.parse(localStorage.getItem("kpiScenarios")) || [];
      
      // 新しいシナリオを追加
      savedScenarios.push(scenarioData);
      
      // ローカルストレージに保存
      localStorage.setItem("kpiScenarios", JSON.stringify(savedScenarios));
      
      // シナリオリストを更新
      updateScenarioList();
      
      return scenarioData;
    }
    
    function loadScenario(scenarioData) {
      // 入力フィールドに値を設定
      document.getElementById("currentPV").value = scenarioData.currentPV;
      document.getElementById("yearGoal").value = scenarioData.yearGoal;
      document.getElementById("goalPV").value = scenarioData.goalPV;
      document.getElementById("monthlyTarget").value = scenarioData.monthlyTarget;
      document.getElementById("targetDate").value = scenarioData.targetDate;
      
      // シミュレーション更新
      onUpdate();
    }
    
    function deleteScenario(index) {
      // ローカルストレージから既存のシナリオを取得
      let savedScenarios = JSON.parse(localStorage.getItem("kpiScenarios")) || [];
      
      // 指定されたインデックスのシナリオを削除
      savedScenarios.splice(index, 1);
      
      // ローカルストレージに保存
      localStorage.setItem("kpiScenarios", JSON.stringify(savedScenarios));
      
      // シナリオリストを更新
      updateScenarioList();
    }
    
    function updateScenarioList() {
      const scenarioList = document.querySelector(".scenario-list");
      
      // ローカルストレージからシナリオを取得
      const savedScenarios = JSON.parse(localStorage.getItem("kpiScenarios")) || [];
      
      // シナリオリストをクリア
      scenarioList.innerHTML = "";
      
      if (savedScenarios.length === 0) {
        scenarioList.innerHTML = "<div class='scenario-item'>保存されたシナリオはありません</div>";
        return;
      }
      
      // 各シナリオをリストに追加
      savedScenarios.forEach((scenario, index) => {
        const scenarioItem = document.createElement("div");
        scenarioItem.className = "scenario-item";
        
        // 日付のフォーマット
        const date = new Date(scenario.timestamp);
        const dateStr = `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        
        scenarioItem.innerHTML = `
          <div>
            <strong>${scenario.name}</strong><br>
            <small>${dateStr}</small><br>
            <small>PV: ${Number(scenario.currentPV).toLocaleString()} → ${Number(scenario.goalPV).toLocaleString()}, 新規: ${scenario.monthlyTarget}名/月</small>
          </div>
          <div class="scenario-actions">
            <button class="scenario-btn load">読込</button>
            <button class="scenario-btn delete">削除</button>
          </div>
        `;
        
        // イベントリスナーの追加
        const loadBtn = scenarioItem.querySelector(".load");
        const deleteBtn = scenarioItem.querySelector(".delete");
        
        loadBtn.addEventListener("click", () => loadScenario(scenario));
        deleteBtn.addEventListener("click", () => {
          if (confirm(`シナリオ「${scenario.name}」を削除してもよろしいですか？`)) {
            deleteScenario(index);
          }
        });
        
        scenarioList.appendChild(scenarioItem);
      });
    }
    
    // Y2K風のパーティクル効果の実装
    function createParticles() {
      const particleContainer = document.createElement('div');
      particleContainer.className = 'particle-container';
      document.body.appendChild(particleContainer);
      
      // パーティクルの数
      const particleCount = 20;
      
      // パーティクルを生成
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        // ランダムなサイズ
        const size = Math.random() * 10 + 5;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        
        // ランダムな位置
        particle.style.left = `${Math.random() * 100}vw`;
        particle.style.bottom = `-${size}px`;
        
        // ランダムなアニメーション遅延と時間
        const delay = Math.random() * 15;
        const duration = Math.random() * 30 + 15;
        particle.style.animation = `float ${duration}s ${delay}s infinite linear`;
        
        // ランダムな不透明度
        particle.style.opacity = Math.random() * 0.6 + 0.2;
        
        particleContainer.appendChild(particle);
      }
    }
    
    // ホバーエフェクトの追加
    function addButtonHoverEffects() {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(button => {
        button.classList.add('button-hover');
      });
    }
    
    // 入力値変更の検出とデータ更新の頻度制御（デバウンス処理）
    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          func.apply(context, args);
        }, wait);
      };
    }

    window.addEventListener("DOMContentLoaded", ()=>{
      // パーティクル効果の生成
      createParticles();
      
      // ボタンにホバーエフェクトを追加
      addButtonHoverEffects();
      
      // スライダーの連動処理
      function setupSlider(inputId, sliderId, valueDisplayId, min, max, step) {
        const input = document.getElementById(inputId);
        const slider = document.getElementById(sliderId);
        const valueDisplay = slider.nextElementSibling;
        
        // スライダー値変更で入力値を同期
        slider.addEventListener("input", function() {
          input.value = this.value;
          valueDisplay.textContent = Number(this.value).toLocaleString();
          debouncedUpdate();
        });
        
        // 入力値変更でスライダーを同期
        input.addEventListener("input", function() {
          let value = parseInt(this.value) || 0;
          if (value > max) value = max;
          if (value < min) value = min;
          slider.value = value;
          valueDisplay.textContent = Number(value).toLocaleString();
        });
      }
      
      // スライダーのセットアップ
      setupSlider("currentPV", "currentPVSlider", null, 0, 50000, 500);
      setupSlider("goalPV", "goalPVSlider", null, 0, 200000, 1000);
      
      // プラス/マイナスボタンの処理
      const decreaseBtn = document.querySelector(".number-btn.decrease");
      const increaseBtn = document.querySelector(".number-btn.increase");
      const monthlyTargetInput = document.getElementById("monthlyTarget");
      
      decreaseBtn.addEventListener("click", function() {
        let currentValue = parseInt(monthlyTargetInput.value) || 0;
        if (currentValue > 0) {
          monthlyTargetInput.value = currentValue - 1;
          debouncedUpdate();
        }
      });
      
      increaseBtn.addEventListener("click", function() {
        let currentValue = parseInt(monthlyTargetInput.value) || 0;
        if (currentValue < 1000) {
          monthlyTargetInput.value = currentValue + 1;
          debouncedUpdate();
        }
      });
      
      // シナリオ保存ボタンのイベントリスナー
      document.getElementById("saveScenarioBtn").addEventListener("click", () => {
        const scenarioName = document.getElementById("scenarioName").value;
        saveCurrentScenario(scenarioName);
        document.getElementById("scenarioName").value = "";
      });
      
      // 初期表示時にシナリオリストを更新
      updateScenarioList();
      
      // エクスポートボタンのイベントリスナー
      document.getElementById("exportBtn").addEventListener("click", () => {
        const simData = recalcKpiData();
        exportToCSV(simData);
      });
      
      // リアルタイム更新機能の実装
      const inputFields = ["currentPV", "yearGoal", "goalPV", "monthlyTarget", "targetDate"];
      const debouncedUpdate = debounce(onUpdate, 500); // 500ms後に更新
      
      inputFields.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener("input", debouncedUpdate);
          // selectの場合はchangeイベントも監視
          if (element.tagName === "SELECT") {
            element.addEventListener("change", debouncedUpdate);
          }
        }
      });
      
      // 入力フィールドにツールチップクラスを追加
      const addTooltip = (elementId, tooltipText) => {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        const tooltipIcon = document.createElement("span");
        tooltipIcon.className = "tooltip-icon";
        tooltipIcon.innerHTML = "ⓘ";
        tooltipIcon.style.position = "absolute";
        tooltipIcon.style.right = "10px";
        tooltipIcon.style.top = "10px";
        tooltipIcon.style.color = "#6a11cb";
        tooltipIcon.style.cursor = "help";
        
        const tooltipContent = document.createElement("div");
        tooltipContent.className = "tooltip-content";
        tooltipContent.innerHTML = tooltipText;
        tooltipContent.style.display = "none";
        tooltipContent.style.position = "absolute";
        tooltipContent.style.background = "linear-gradient(45deg, rgba(106, 17, 203, 0.9), rgba(37, 117, 252, 0.9))";
        tooltipContent.style.padding = "10px";
        tooltipContent.style.borderRadius = "8px";
        tooltipContent.style.boxShadow = "0 3px 10px rgba(0,0,0,0.2)";
        tooltipContent.style.zIndex = "100";
        tooltipContent.style.width = "200px";
        tooltipContent.style.fontSize = "0.8rem";
        tooltipContent.style.right = "0";
        tooltipContent.style.top = "30px";
        tooltipContent.style.color = "white";
        tooltipContent.style.border = "1px solid rgba(255, 255, 255, 0.3)";
        
        // 特別なケース: 新規登録者数フィールド
        if (elementId === "monthlyTarget") {
          tooltipIcon.style.right = "-25px";
        }
        
        element.parentNode.style.position = "relative";
        element.parentNode.appendChild(tooltipIcon);
        element.parentNode.appendChild(tooltipContent);
        
        tooltipIcon.addEventListener("mouseenter", () => {
          tooltipContent.style.display = "block";
        });
        
        tooltipIcon.addEventListener("mouseleave", () => {
          tooltipContent.style.display = "none";
        });
      };
      
      // ツールチップの追加
      addTooltip("currentPV", "現在のPV（ポイントバリュー）の値を入力してください。");
      addTooltip("yearGoal", "今年の目標ランクを選択してください。");
      addTooltip("goalPV", "達成したい目標PVを入力してください。");
      addTooltip("monthlyTarget", "毎月の新規登録者数の目標値を入力してください。");
      addTooltip("targetDate", "目標設定の開始日を選択してください。");
      
      onUpdate();
    });
  </script>
</body>
</html>
